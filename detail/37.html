<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Shanghai Jiaotong University</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Shanghai Jiaotong University</h1>
    <div class="pagination">
        <span>[1]</span><a href='37_2.html'>2</a><a href='37_2.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 2bed2ced40c97b8540ff38df0149e8ecb2bf4c65
Author: Jiacheng Shi &lt;billsjc@sjtu.edu.cn&gt;
Date:   Sun Dec 12 01:16:00 2021 -0800

    vfio/iommu_type1: replace kfree with kvfree
    
    Variables allocated by kvzalloc should not be freed by kfree.
    Because they may be allocated by vmalloc.
    So we replace kfree with kvfree here.
    
    Fixes: d6a4c185660c ("vfio iommu: Implementation of ioctl for dirty pages tracking")
    Signed-off-by: Jiacheng Shi &lt;billsjc@sjtu.edu.cn&gt;
    Link: https://lore.kernel.org/r/20211212091600.2560-1-billsjc@sjtu.edu.cn
    Signed-off-by: Alex Williamson &lt;alex.williamson@redhat.com&gt;

diff --git a/drivers/vfio/vfio_iommu_type1.c b/drivers/vfio/vfio_iommu_type1.c
index f17490ab238f..9394aa9444c1 100644
--- a/drivers/vfio/vfio_iommu_type1.c
+++ b/drivers/vfio/vfio_iommu_type1.c
@@ -256,7 +256,7 @@ static int vfio_dma_bitmap_alloc(struct vfio_dma *dma, size_t pgsize)
 
 static void vfio_dma_bitmap_free(struct vfio_dma *dma)
 {
-	kfree(dma-&gt;bitmap);
+	kvfree(dma-&gt;bitmap);
 	dma-&gt;bitmap = NULL;
 }
 </pre><hr><pre>commit 12d3bbdd6bd2780b71cc466f3fbc6eb7d43bbc2a
Author: Jiacheng Shi &lt;billsjc@sjtu.edu.cn&gt;
Date:   Fri Dec 10 01:42:34 2021 -0800

    RDMA/hns: Replace kfree() with kvfree()
    
    Variables allocated by kvmalloc_array() should not be freed by kfree.
    Because they may be allocated by vmalloc.  So we replace kfree() with
    kvfree() here.
    
    Fixes: 6fd610c5733d ("RDMA/hns: Support 0 hop addressing for SRQ buffer")
    Link: https://lore.kernel.org/r/20211210094234.5829-1-billsjc@sjtu.edu.cn
    Signed-off-by: Jiacheng Shi &lt;billsjc@sjtu.edu.cn&gt;
    Acked-by: Wenpeng Liang &lt;liangwenpeng@huawei.com&gt;
    Signed-off-by: Jason Gunthorpe &lt;jgg@nvidia.com&gt;

diff --git a/drivers/infiniband/hw/hns/hns_roce_srq.c b/drivers/infiniband/hw/hns/hns_roce_srq.c
index 6eee9deadd12..e64ef6903fb4 100644
--- a/drivers/infiniband/hw/hns/hns_roce_srq.c
+++ b/drivers/infiniband/hw/hns/hns_roce_srq.c
@@ -259,7 +259,7 @@ static int alloc_srq_wrid(struct hns_roce_dev *hr_dev, struct hns_roce_srq *srq)
 
 static void free_srq_wrid(struct hns_roce_srq *srq)
 {
-	kfree(srq-&gt;wrid);
+	kvfree(srq-&gt;wrid);
 	srq-&gt;wrid = NULL;
 }
 </pre><hr><pre>commit d4996c6eac4c81b8872043e9391563f67f13e406
Author: Guo Zhi &lt;qtxuning1999@sjtu.edu.cn&gt;
Date:   Wed Sep 29 20:25:37 2021 +0800

    scsi: advansys: Fix kernel pointer leak
    
    Pointers should be printed with %p or %px rather than cast to 'unsigned
    long' and printed with %lx.
    
    Change %lx to %p to print the hashed pointer.
    
    Link: https://lore.kernel.org/r/20210929122538.1158235-1-qtxuning1999@sjtu.edu.cn
    Signed-off-by: Guo Zhi &lt;qtxuning1999@sjtu.edu.cn&gt;
    Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;

diff --git a/drivers/scsi/advansys.c b/drivers/scsi/advansys.c
index e341b3372482..2df2a843a5ff 100644
--- a/drivers/scsi/advansys.c
+++ b/drivers/scsi/advansys.c
@@ -3308,8 +3308,8 @@ static void asc_prt_adv_board_info(struct seq_file *m, struct Scsi_Host *shost)
 		   shost-&gt;host_no);
 
 	seq_printf(m,
-		   " iop_base 0x%lx, cable_detect: %X, err_code %u\n",
-		   (unsigned long)v-&gt;iop_base,
+		   " iop_base 0x%p, cable_detect: %X, err_code %u\n",
+		   v-&gt;iop_base,
 		   AdvReadWordRegister(iop_base,IOPW_SCSI_CFG1) &amp; CABLE_DETECT,
 		   v-&gt;err_code);
 </pre><hr><pre>commit 7d5cfafe8b4006a75b55c2f1fdfdb363f9a5cc98
Author: Guo Zhi &lt;qtxuning1999@sjtu.edu.cn&gt;
Date:   Wed Sep 22 21:48:57 2021 +0800

    RDMA/hfi1: Fix kernel pointer leak
    
    Pointers should be printed with %p or %px rather than cast to 'unsigned
    long long' and printed with %llx.  Change %llx to %p to print the secured
    pointer.
    
    Fixes: 042a00f93aad ("IB/{ipoib,hfi1}: Add a timeout handler for rdma_netdev")
    Link: https://lore.kernel.org/r/20210922134857.619602-1-qtxuning1999@sjtu.edu.cn
    Signed-off-by: Guo Zhi &lt;qtxuning1999@sjtu.edu.cn&gt;
    Acked-by: Mike Marciniszyn &lt;mike.marciniszyn@cornelisnetworks.com&gt;
    Signed-off-by: Jason Gunthorpe &lt;jgg@nvidia.com&gt;

diff --git a/drivers/infiniband/hw/hfi1/ipoib_tx.c b/drivers/infiniband/hw/hfi1/ipoib_tx.c
index e74ddbe46589..15b0cb0f363f 100644
--- a/drivers/infiniband/hw/hfi1/ipoib_tx.c
+++ b/drivers/infiniband/hw/hfi1/ipoib_tx.c
@@ -876,14 +876,14 @@ void hfi1_ipoib_tx_timeout(struct net_device *dev, unsigned int q)
 	struct hfi1_ipoib_txq *txq = &amp;priv-&gt;txqs[q];
 	u64 completed = atomic64_read(&amp;txq-&gt;complete_txreqs);
 
-	dd_dev_info(priv-&gt;dd, "timeout txq %llx q %u stopped %u stops %d no_desc %d ring_full %d\n",
-		    (unsigned long long)txq, q,
+	dd_dev_info(priv-&gt;dd, "timeout txq %p q %u stopped %u stops %d no_desc %d ring_full %d\n",
+		    txq, q,
 		    __netif_subqueue_stopped(dev, txq-&gt;q_idx),
 		    atomic_read(&amp;txq-&gt;stops),
 		    atomic_read(&amp;txq-&gt;no_desc),
 		    atomic_read(&amp;txq-&gt;ring_full));
-	dd_dev_info(priv-&gt;dd, "sde %llx engine %u\n",
-		    (unsigned long long)txq-&gt;sde,
+	dd_dev_info(priv-&gt;dd, "sde %p engine %u\n",
+		    txq-&gt;sde,
 		    txq-&gt;sde ? txq-&gt;sde-&gt;this_idx : 0);
 	dd_dev_info(priv-&gt;dd, "flow %x\n", txq-&gt;flow.as_int);
 	dd_dev_info(priv-&gt;dd, "sent %llu completed %llu used %llu\n",</pre><hr><pre>commit 5bfea2d9b17f1034a68147a8b03b9789af5700f9
Author: Fan Yang &lt;Fan_Yang@sjtu.edu.cn&gt;
Date:   Thu Jun 4 18:22:07 2020 +0800

    mm: Fix mremap not considering huge pmd devmap
    
    The original code in mm/mremap.c checks huge pmd by:
    
                    if (is_swap_pmd(*old_pmd) || pmd_trans_huge(*old_pmd)) {
    
    However, a DAX mapped nvdimm is mapped as huge page (by default) but it
    is not transparent huge page (_PAGE_PSE | PAGE_DEVMAP).  This commit
    changes the condition to include the case.
    
    This addresses CVE-2020-10757.
    
    Fixes: 5c7fb56e5e3f ("mm, dax: dax-pmd vs thp-pmd vs hugetlbfs-pmd")
    Cc: &lt;stable@vger.kernel.org&gt;
    Reported-by: Fan Yang &lt;Fan_Yang@sjtu.edu.cn&gt;
    Signed-off-by: Fan Yang &lt;Fan_Yang@sjtu.edu.cn&gt;
    Tested-by: Fan Yang &lt;Fan_Yang@sjtu.edu.cn&gt;
    Tested-by: Dan Williams &lt;dan.j.williams@intel.com&gt;
    Reviewed-by: Dan Williams &lt;dan.j.williams@intel.com&gt;
    Acked-by: Kirill A. Shutemov &lt;kirill.shutemov@linux.intel.com&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/arch/x86/include/asm/pgtable.h b/arch/x86/include/asm/pgtable.h
index f51d8997ed00..b8f46bbe69f4 100644
--- a/arch/x86/include/asm/pgtable.h
+++ b/arch/x86/include/asm/pgtable.h
@@ -257,6 +257,7 @@ static inline int pmd_large(pmd_t pte)
 }
 
 #ifdef CONFIG_TRANSPARENT_HUGEPAGE
+/* NOTE: when predicate huge page, consider also pmd_devmap, or use pmd_large */
 static inline int pmd_trans_huge(pmd_t pmd)
 {
 	return (pmd_val(pmd) &amp; (_PAGE_PSE|_PAGE_DEVMAP)) == _PAGE_PSE;
diff --git a/mm/mremap.c b/mm/mremap.c
index 6aa6ea605068..57b1f999f789 100644
--- a/mm/mremap.c
+++ b/mm/mremap.c
@@ -266,7 +266,7 @@ unsigned long move_page_tables(struct vm_area_struct *vma,
 		new_pmd = alloc_new_pmd(vma-&gt;vm_mm, vma, new_addr);
 		if (!new_pmd)
 			break;
-		if (is_swap_pmd(*old_pmd) || pmd_trans_huge(*old_pmd)) {
+		if (is_swap_pmd(*old_pmd) || pmd_trans_huge(*old_pmd) || pmd_devmap(*old_pmd)) {
 			if (extent == HPAGE_PMD_SIZE) {
 				bool moved;
 				/* See comment in move_ptes() */</pre><hr><pre>commit aad7012c3152209d49b5442550e2aae09bfe7947
Author: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
Date:   Fri Jul 19 09:19:43 2019 +0800

    drm/amdgpu: fix two documentation mismatch issues
    
    The function name mentioned in the documentational comments mismatches
    the actual one. The mismatch may make trouble for automatic documentation
    generation. One of the erronous name has seen to be misused
    and fixed in commit bc5ab2d29b8a ("drm/amdgpu: fix typo in function
    sdma_v4_0_page_resume").
    
    There is apparently no functional change in the patch.
    
    Signed-off-by: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
    Reviewed-by: Christian KÃ¶nig &lt;christian.koenig@amd.com&gt;
    Reviewed-by: Huang Rui &lt;ray.huang@amd.com&gt;
    Signed-off-by: Jiri Kosina &lt;jkosina@suse.cz&gt;

diff --git a/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c b/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c
index e55884d204bd..52a858cd9a91 100644
--- a/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c
+++ b/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c
@@ -677,7 +677,7 @@ static uint64_t sdma_v4_0_ring_get_wptr(struct amdgpu_ring *ring)
 }
 
 /**
- * sdma_v4_0_ring_set_wptr - commit the write pointer
+ * sdma_v4_0_page_ring_set_wptr - commit the write pointer
  *
  * @ring: amdgpu ring pointer
  *
@@ -977,7 +977,7 @@ static void sdma_v4_0_page_stop(struct amdgpu_device *adev)
 }
 
 /**
- * sdma_v_0_ctx_switch_enable - stop the async dma engines context switch
+ * sdma_v4_0_ctx_switch_enable - stop the async dma engines context switch
  *
  * @adev: amdgpu_device pointer
  * @enable: enable/disable the DMA MEs context switch.</pre><hr><pre>commit 91d99a724e9c60e14332c26ab2284bf696b94c8e
Author: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
Date:   Fri Sep 20 14:55:47 2019 +0800

    nios2: force the string buffer NULL-terminated
    
    strncpy() does not ensure NULL-termination when the input string
    size equals to the destination buffer size COMMAND_LINE_SIZE.
    Besides, grep under arch/ with 'boot_command_line' shows
    no other arch-specific code uses strncpy() when copying
    boot_command_line.
    
    Use strlcpy() instead.
    
    This issue is identified by a Coccinelle script.
    
    Signed-off-by: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
    Signed-off-by: Ley Foon Tan &lt;ley.foon.tan@intel.com&gt;

diff --git a/arch/nios2/kernel/setup.c b/arch/nios2/kernel/setup.c
index 6bbd4ae2beb0..4cf35b09c0ec 100644
--- a/arch/nios2/kernel/setup.c
+++ b/arch/nios2/kernel/setup.c
@@ -123,7 +123,7 @@ asmlinkage void __init nios2_boot_init(unsigned r4, unsigned r5, unsigned r6,
 		dtb_passed = r6;
 
 		if (r7)
-			strncpy(cmdline_passed, (char *)r7, COMMAND_LINE_SIZE);
+			strlcpy(cmdline_passed, (char *)r7, COMMAND_LINE_SIZE);
 	}
 #endif
 
@@ -131,10 +131,10 @@ asmlinkage void __init nios2_boot_init(unsigned r4, unsigned r5, unsigned r6,
 
 #ifndef CONFIG_CMDLINE_FORCE
 	if (cmdline_passed[0])
-		strncpy(boot_command_line, cmdline_passed, COMMAND_LINE_SIZE);
+		strlcpy(boot_command_line, cmdline_passed, COMMAND_LINE_SIZE);
 #ifdef CONFIG_NIOS2_CMDLINE_IGNORE_DTB
 	else
-		strncpy(boot_command_line, CONFIG_CMDLINE, COMMAND_LINE_SIZE);
+		strlcpy(boot_command_line, CONFIG_CMDLINE, COMMAND_LINE_SIZE);
 #endif
 #endif
 </pre><hr><pre>commit 3690c8c9a8edff0db077a38783112d8fe12a7dd2
Author: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
Date:   Wed Jul 31 16:15:42 2019 +0800

    net/ethernet/qlogic/qed: force the string buffer NULL-terminated
    
    strncpy() does not ensure NULL-termination when the input string
    size equals to the destination buffer size 30.
    The output string is passed to qed_int_deassertion_aeu_bit()
    which calls DP_INFO() and relies NULL-termination.
    
    Use strlcpy instead. The other conditional branch above strncpy()
    needs no fix as snprintf() ensures NULL-termination.
    
    This issue is identified by a Coccinelle script.
    
    Signed-off-by: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
    Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;

diff --git a/drivers/net/ethernet/qlogic/qed/qed_int.c b/drivers/net/ethernet/qlogic/qed/qed_int.c
index 4e8118a08654..9f5113639eaf 100644
--- a/drivers/net/ethernet/qlogic/qed/qed_int.c
+++ b/drivers/net/ethernet/qlogic/qed/qed_int.c
@@ -1093,7 +1093,7 @@ static int qed_int_deassertion(struct qed_hwfn  *p_hwfn,
 						snprintf(bit_name, 30,
 							 p_aeu-&gt;bit_name, num);
 					else
-						strncpy(bit_name,
+						strlcpy(bit_name,
 							p_aeu-&gt;bit_name, 30);
 
 					/* We now need to pass bitmask in its</pre><hr><pre>commit e787f19373b8a5fa24087800ed78314fd17b984a
Author: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
Date:   Wed Jul 31 15:25:59 2019 +0800

    can: peak_usb: force the string buffer NULL-terminated
    
    strncpy() does not ensure NULL-termination when the input string size
    equals to the destination buffer size IFNAMSIZ. The output string is
    passed to dev_info() which relies on the NULL-termination.
    
    Use strlcpy() instead.
    
    This issue is identified by a Coccinelle script.
    
    Signed-off-by: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
    Signed-off-by: Marc Kleine-Budde &lt;mkl@pengutronix.de&gt;

diff --git a/drivers/net/can/usb/peak_usb/pcan_usb_core.c b/drivers/net/can/usb/peak_usb/pcan_usb_core.c
index 22b9c8e6d040..65dce642b86b 100644
--- a/drivers/net/can/usb/peak_usb/pcan_usb_core.c
+++ b/drivers/net/can/usb/peak_usb/pcan_usb_core.c
@@ -855,7 +855,7 @@ static void peak_usb_disconnect(struct usb_interface *intf)
 
 		dev_prev_siblings = dev-&gt;prev_siblings;
 		dev-&gt;state &amp;= ~PCAN_USB_STATE_CONNECTED;
-		strncpy(name, netdev-&gt;name, IFNAMSIZ);
+		strlcpy(name, netdev-&gt;name, IFNAMSIZ);
 
 		unregister_netdev(netdev);
 </pre><hr><pre>commit cd28aa2e056cd1ea79fc5f24eed0ce868c6cab5c
Author: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
Date:   Wed Jul 31 15:31:14 2019 +0800

    can: sja1000: force the string buffer NULL-terminated
    
    strncpy() does not ensure NULL-termination when the input string size
    equals to the destination buffer size IFNAMSIZ. The output string
    'name' is passed to dev_info which relies on NULL-termination.
    
    Use strlcpy() instead.
    
    This issue is identified by a Coccinelle script.
    
    Signed-off-by: Wang Xiayang &lt;xywang.sjtu@sjtu.edu.cn&gt;
    Signed-off-by: Marc Kleine-Budde &lt;mkl@pengutronix.de&gt;

diff --git a/drivers/net/can/sja1000/peak_pcmcia.c b/drivers/net/can/sja1000/peak_pcmcia.c
index 185c7f7d38a4..5e0d5e8101c8 100644
--- a/drivers/net/can/sja1000/peak_pcmcia.c
+++ b/drivers/net/can/sja1000/peak_pcmcia.c
@@ -479,7 +479,7 @@ static void pcan_free_channels(struct pcan_pccard *card)
 		if (!netdev)
 			continue;
 
-		strncpy(name, netdev-&gt;name, IFNAMSIZ);
+		strlcpy(name, netdev-&gt;name, IFNAMSIZ);
 
 		unregister_sja1000dev(netdev);
 </pre>
    <div class="pagination">
        <span>[1]</span><a href='37_2.html'>2</a><a href='37_2.html'>Next&gt;&gt;</a>
    <div>
</body>
